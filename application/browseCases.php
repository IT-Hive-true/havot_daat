<?phprequire_once 'generalPHP.php';require_once 'pageBuilder.php';require_once 'db.php';$db_server = mysqli_connect($db_hostname, $db_username, $db_password,$db_database);if (isset($_GET['filterText'])){	$filterText = sanitizeMySQL($_GET['filterText']);} else {	// dudy 3/4/2016	$filterText = '';}// dudy 8/6/2016if (isset($_GET['filterText_names'])){	$filterText_names = sanitizeMySQL($_GET['filterText_names']);} else {		$filterText_names = '';}// dudy 3/4/2016if (isset($_GET['show_deleted_cases']) && $_GET['show_deleted_cases'] == 'show_deleted_cases'){	$show_deleted_cases = true;} else {		$show_deleted_cases = false;}// dudy 3/4/2016if (isset($_GET['show_closed_cases']) && $_GET['show_closed_cases'] == 'show_closed_cases'){	$show_closed_cases = true;} else {		$show_closed_cases = false;}if (isset($_GET['prosecutor'])){	$prosecutorText = sanitizeMySQL($_GET['prosecutor']);}pageStart("מערכת קליניקה - חיפוש תיק");echo <<<_END<br /><br /><h1><center><img src="images/icon_search-people.png" height="50px"/>&nbsp;&nbsp;חפש תיק</center></h1><form id="filterForm" name="filterForm" action="browseCases.php">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;חיפוש שמי בלבד:&nbsp;&nbsp;<input name="filterText_names" id="filterText_names" type="text" /></br></br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;חיפוש בכל השדות:&nbsp;<input name="filterText" id="filterText" type="text" />_END;if ($show_deleted_cases) {	echo '<input type="checkbox" name="show_deleted_cases" value="show_deleted_cases" checked>';} else {	echo '<input type="checkbox" name="show_deleted_cases" value="show_deleted_cases">';}echo 'הצג תיקים שאוחדו ונמחקו';echo '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';if ($show_closed_cases) {	echo '<input type="checkbox" name="show_closed_cases" value="show_closed_cases" checked>';} else {	echo '<input type="checkbox" name="show_closed_cases" value="show_closed_cases">';}echo 'הצג תיקים בסטטוס סגור';echo <<<_END</br></br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src="/images/Search.png" width="30px" />&nbsp;<button type="submit" >חפש בכל מסד הנתונים</button></form><br /><br />_END;echo "<div id=\"casesTableDiv\">";echo <<<_END <table id="casesTable" class="tablesorter"><thead><tr> 	<th>מס' מזהה</th>    <th>שם פציינט</th>     <th>ת.ז.</th>     <th>סטטוס</th>    <th>תאריך מינוי</th>    <th>ת.א.</th>    <th>בית משפט</th>    <th>תאריך ביקור אחרון</th>	<th>תגיות</th>	<th>שם השופט</th>	<th>עו"ד תובע</th>		<th>עו"ד נתבע</th>			<th>עו"ד נתבע 2</th>		<th>חברת הביטוח</th>		<th>חברת הביטוח 2</th>	<th>סכום ללא מע"מ</th>	</tr> </thead><tbody>_END;$query = "	SELECT 	 t1.id					,t2.name					,t1.patient_name					,t1.patient_id					,DATE_FORMAT(date(t1.appointment_date),'%d/%m/%Y')					,t1.court_num					,t3.type					,t3.location					,t1.appointment_type					,t1.tags					,t1.judge_name					,t1.prosecutor_name					,t1.defence_lawyer_name					,t1.defence_lawyer_name_2					,t4.name as i_company1   					,t4_2.name as i_company2					,t1.payment_amount			FROM 	 tbcases as t1					,tbstatus as t2					,tbcourts as t3					,tbcompanies as t4					,tbcompanies as t4_2			WHERE 	(t1.status = t2.id) and 					(t1.court_id = t3.id) and					(t1.defence_company_id = t4.id) and					(t1.defence_company_2_id = t4_2.id) and";if ( !empty($filterText_names) ) {		$query .= "		(t1.patient_name like '%".$filterText."%') and ";} else {		$query .= "			((t1.patient_name like '%".$filterText."%') or 					(t1.patient_id like '%".$filterText."%') or 					(t1.remarks like '%".$filterText."%') or					(t1.judge_name like '%".$filterText."%') or					(t1.defence_lawyer_name like '%".$filterText."%') or					(t1.payment_amount like '%".$filterText."%') or					(t1.prosecutor_name like '%".$filterText."%') or					(t1.defence_lawyer_name_2 like '%".$filterText."%') or					(t4.name like '%".$filterText."%') or					(t4_2.name like '%".$filterText."%') or					(t1.tags like '%".$filterText."%')) and ";}if ( $show_deleted_cases ) {	// show deleted cases	} else {	// dont show deleted cases	$query .= "	t2.id != 12 and "; }if ( $show_closed_cases ) {	// show closed cases} else {	// dont show closed cases	$query .= "	t2.id != 8 and "; }if (isset($prosecutorText)) { $query.= "(t1.prosecutor_name like '%".$prosecutorText."%') and ";}				$query .= " (t1.client_id = ".$clientId.")";$result = mysqli_query($db_server,$query);if (!$result) die("Database access failed: " . mysqli_error());elseif (mysqli_num_rows($result)){	$rowsNum = mysqli_num_rows($result);	// Yogev 4/9/2017 bug fix - there are no pages in this grid	// for ($i=0;(($i<$rowsNum) && ($i<$casesInPage));$i++)	for ($i=0 ; $i < $rowsNum  ; $i++)	{		$caseRow = mysqli_fetch_row($result);		$visitSQL = "SELECT DATE_FORMAT(date(t1.timestamp),'%d/%m/%Y')					FROM tbevents as t1					where (t1.case_id = ".$caseRow[0].") and 						  (t1.type = 2)					ORDER BY t1.timestamp desc					LIMIT 0,1";							$visitResult = mysqli_query($db_server,$visitSQL);		if (!$visitResult) die("Database access failed: " . mysqli_error());		elseif (mysqli_num_rows($visitResult))		{			$visitRow = mysqli_fetch_row($visitResult);			$visitDate = $visitRow[0];		}		else		{			$visitDate = "";		}				echo "<tr class=\"linkble\" onclick=\"window.location = 'showCase.php?id=".$caseRow[0]."'\">";			echo "<td>";				echo $caseRow[0];			echo "</td>";				echo "<td>";				echo $caseRow[2];			echo "</td>";			echo "<td>";				echo $caseRow[3];			echo "</td>";			echo "<td>";				echo $caseRow[1];			echo "</td>";			echo "<td>";				echo $caseRow[4];			echo "</td>";			echo "<td>";				echo $caseRow[5];			echo "</td>";			echo "<td>";				if ($caseRow[8] == 1)				{					echo "ה".$courtType[$caseRow[6]]." ב".$caseRow[7];				}				else				{					echo $caseType[$caseRow[8]];					}			echo "</td>";			echo "<td>";				echo $visitDate;			echo "</td>";						echo "<td>";				echo $caseRow[9];			echo "</td>";						echo "<td>";				echo $caseRow[10];			echo "</td>";			echo "<td>";				echo $caseRow[11];			echo "</td>";			echo "<td>";				echo $caseRow[12];			echo "</td>";			echo "<td>";				echo $caseRow[13];			echo "</td>";				echo "<td>";				echo $caseRow[14];			echo "</td>";			echo "<td>";				echo $caseRow[15];			echo "</td>";				echo "<td>";				echo $caseRow[16];			echo "</td>";								echo "</tr>";	}}else{	echo "<BR /><BR /><center><b><p>אין תיקים במערכת</p></b></center><BR /><BR /><BR />";}echo "</tbody>";echo "</table>";echo "</div>";echo <<<_END<script>$(function() { 	var theTable = $('#casesTable');	$("#filterText").keyup(function() {		$.uiTableFilter( theTable, this.value );	});	$("#filterText_names").keyup(function() {		var patient_name = 'שם פציינט';		$.uiTableFilter( theTable, this.value , patient_name  );	});	  	  }); $(document).ready(function() { 	$.tablesorter.addParser({        id: "israelDate",        is: function (s) {           // return false so this parser is not auto detected             return false;         }, format: function (s) {            s = s.replace(/\-/g, "/");            s = s.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/, "$3/$2/$1");            return $.tablesorter.formatFloat(new Date(s).getTime());        }, type: "numeric"    });        // call the tablesorter plugin 	$("#casesTable").tablesorter({         // sort on the first column and third column, order asc         sortList: [[1,0],[7,1]],        headers: { 4: { sorter:'israelDate' }, 7: { sorter:'israelDate' } }    });     }); </script>_END;pageEnd();